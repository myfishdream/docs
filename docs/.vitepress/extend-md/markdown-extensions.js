/**
 * GitHub 风格的警告框扩展
 * 支持类型: BUG, FAILURE, QUESTION, SUCCESS, INFO
 */

// 警告框定义
const alertTypes = [
  {
    type: 'bug',
    title: 'BUG',
    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 1024 1024"><path d="M940 512H792V412c76.8 0 139-62.2 139-139 0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 34.8-28.2 63-63 63H232c-34.8 0-63-28.2-63-63 0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 76.8 62.2 139 139 139v100H84c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h148v96c0 6.5 0.2 13 0.7 19.3C164.1 728.6 116 796.7 116 876c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8 0-44.2 23.9-82.9 59.6-103.7 6 17.2 13.6 33.6 22.7 49 24.3 41.5 59 76.2 100.5 100.5S460.5 960 512 960s99.8-13.9 141.3-38.2c41.5-24.3 76.2-59 100.5-100.5 9.1-15.5 16.7-31.9 22.7-49C812.1 793.1 836 831.8 836 876c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8 0-79.3-48.1-147.4-116.7-176.7 0.4-6.4 0.7-12.8 0.7-19.3v-96h148c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM716 680c0 36.8-9.7 72-27.8 102.9-17.7 30.3-43 55.6-73.3 73.3-20.1 11.8-42 20-64.9 24.3V484c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v396.5c-22.9-4.3-44.8-12.5-64.9-24.3-30.3-17.7-55.6-43-73.3-73.3C317.7 752 308 716.8 308 680V412h408v268z M304 280h56c4.4 0 8-3.6 8-8 0-28.3 5.9-53.2 17.1-73.5 10.6-19.4 26-34.8 45.4-45.4C450.9 142 475.7 136 504 136h16c28.3 0 53.2 5.9 73.5 17.1 19.4 10.6 34.8 26 45.4 45.4C650 218.9 656 243.7 656 272c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8 0-40-8.8-76.7-25.9-108.1-17.2-31.5-42.5-56.8-74-74C596.7 72.8 560 64 520 64h-16c-40 0-76.7 8.8-108.1 25.9-31.5 17.2-56.8 42.5-74 74C304.8 195.3 296 232 296 272c0 4.4 3.6 8 8 8z" fill="currentColor"/></svg>',
    color: '#e7c000'
  },
  {
    type: 'failure',
    title: 'FAILURE',
    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 1024 1024"><path d="M512.02 958.69c-246.34 0-446.73-200.39-446.73-446.69S265.68 65.31 512.02 65.31c246.3 0 446.69 200.39 446.69 446.69S758.32 958.69 512.02 958.69zM512.02 129.54c-210.92 0-382.5 171.57-382.5 382.46s171.57 382.46 382.5 382.46c210.88 0 382.46-171.57 382.46-382.46S722.9 129.54 512.02 129.54z M330.83 725.27c-8.24 0-16.43-3.14-22.71-9.41-12.54-12.54-12.54-32.87 0-45.41l362.34-362.34c12.54-12.54 32.87-12.54 45.41 0 12.54 12.54 12.54 32.87 0 45.41L353.53 715.86c-6.27 6.27-14.47 9.41-22.7 9.41z M693.17 725.27c-8.24 0-16.43-3.14-22.71-9.41L308.12 353.51c-12.54-12.54-12.54-32.87 0-45.41 12.54-12.54 32.87-12.54 45.41 0l362.34 362.34c12.54 12.54 12.54 32.87 0 45.41-6.27 6.27-14.47 9.41-22.7 9.41z" fill="currentColor"/></svg>',
    color: '#e03131'
  }, 
  {
    type: 'question',
    title: 'QUESTION',
    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 1024 1024"><path d="M517.12 954.88c244.59 0 442.88-198.29 442.88-442.88 0-244.59-198.29-442.88-442.88-442.88C272.52 69.12 74.24 267.4 74.24 512s198.28 442.88 442.88 442.88zm0-63.27c-209.65 0-379.61-169.96-379.61-379.61s169.96-379.61 379.61-379.61 379.61 169.96 379.61 379.61-169.96 379.61-379.61 379.61zm6.83-647.62c-54.66 0-97.18 16.71-127.55 50.11-30.37 31.89-44.8 74.4-44.8 127.55h59.98c0-37.2 8.35-66.05 25.06-87.31 18.22-25.06 46.31-37.2 84.27-37.2 31.89 0 56.95 8.35 74.41 26.57 16.7 16.7 25.81 40.24 25.81 70.61 0 21.26-7.59 41-22.78 59.98-4.55 6.07-13.67 15.19-25.81 27.33-41 36.45-66.06 65.3-76.69 88.08-9.11 18.98-13.67 41-13.67 66.05v17.47h60.74v-17.47c0-20.5 4.56-38.73 14.43-55.43 7.59-13.67 18.98-27.34 35.68-41.76 33.41-29.61 53.91-49.35 61.5-58.46 18.98-25.06 28.85-54.67 28.85-88.83 0-45.55-14.43-81.24-42.52-107.05-28.08-27.34-66.8-40.25-115.39-40.25zm-11.39 462.37c-12.91 0-23.54 3.8-32.65 12.91-9.11 8.35-12.91 18.98-12.91 31.89s3.8 23.54 12.91 32.65c9.11 8.35 19.74 12.91 32.65 12.91 12.91 0 23.54-4.56 32.65-12.91 9.11-8.36 13.67-18.99 13.67-32.65 0-12.91-4.56-23.54-12.91-31.89-9.11-8.35-20.5-12.91-33.41-12.91z" fill="currentColor"/></svg>',
    color: '#f08c00'
  },
  {
    type: 'success',
    title: 'SUCCESS',
    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 1024 1024"><path d="M512 0C230.4 0 0 230.4 0 512s230.4 512 512 512 512-230.4 512-512S793.6 0 512 0zm0 960c-249.6 0-448-204.8-448-448S262.4 64 512 64s448 198.4 448 448-198.4 448-448 448zm179.2-620.8L454.4 576 332.8 454.4c-19.2-19.2-51.2-19.2-76.8 0-12.8 25.6-12.8 57.6 6.4 76.8l153.6 153.6c19.2 19.2 51.2 19.2 70.4 0l51.2-51.2 224-224c19.2-19.2 25.6-51.2 0-70.4-25.6-19.2-57.6-19.2-76.8 0z" fill="currentColor"/></svg>',
    color: '#37b24d'
  },
  {
    type: 'info',
    title: 'INFO',
    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 1024 1024"><path d="M560 800l-10.464-416h-75.072L464 800h96z m-14.144-493.984c9.44-9.312 14.144-20.672 14.144-34.016 0-13.6-4.704-24.992-14.144-34.208A46.784 46.784 0 0 0 512 224c-13.12 0-24.448 4.608-33.856 13.792A45.856 45.856 0 0 0 464 272c0 13.344 4.704 24.704 14.144 34.016 9.408 9.312 20.704 13.984 33.856 13.984 13.12 0 24.448-4.672 33.856-13.984zM512 32C246.912 32 32 246.912 32 512c0 265.088 214.912 480 480 480 265.088 0 480-214.912 480-480 0-265.088-214.912-480-480-480z m0 64c229.76 0 416 186.24 416 416s-186.24 416-416 416S96 741.76 96 512 282.24 96 512 96z" fill="currentColor"/></svg>',
    color: '#0ca678'
  }
];

/**
 * 为 markdown-it 添加 GitHub 风格的警告框支持
 * @param {MarkdownIt} md - markdown-it 实例 
 */
export function setupAlertBoxes(md) {
  // 保存原始的 render 方法
  const defaultRender = md.render;
  
  md.render = function(src, env) {
    // 处理 GitHub 风格的警告框
    let processed = src;
    
    // 为每种警告框类型创建替换规则
    alertTypes.forEach(alert => {
      const regex = new RegExp(`^>\\s*\\[!${alert.title}\\]\\s*\\n((?:>\\s*.*(?:\\n|$))+)`, 'gm');
      
      processed = processed.replace(regex, (match, content) => {
        // 提取实际内容（去除每行开头的 >）
        const cleanContent = content
          .split('\n')
          .map(line => line.replace(/^>\s*/, ''))
          .filter(line => line.trim() !== '')
          .join('\n');
        
        return `<div class="custom-block ${alert.type}">
          <p class="custom-block-title">
            <span class="alert-icon">${alert.icon}</span>
            ${alert.title}
          </p>
          <p>${cleanContent}</p>
        </div>\n\n`;
      });
    });
    
    // 使用原始的 render 方法处理预处理后的文本
    return defaultRender.call(this, processed, env);
  };
}

